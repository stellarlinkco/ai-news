name: daily-ai-news

on:
  schedule:
    - cron: "15 1 * * *"
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  collect:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run orchestrator (codex+skill entry)
        uses: openai/codex-action@v1
        with:
          openai-api-key: ${{ secrets.OPENAI_API_KEY }}
          codex-version: 0.104.0
          sandbox: danger-full-access
          prompt: |
            你是该仓库的每日 AI News 编排器，执行 codex+skill 入口。
            严格按顺序执行并在失败时退出：
            1) python scripts/rss_audit.py --sources config/sources.yaml --out data/rss-audit-latest.json --update
            2) python scripts/pipeline.py --sources config/sources.yaml --update-sources --use-codex
            约束：
            - 仅允许修改 config/sources.yaml、data/、web/ 下的产物文件。
            - 不要修改 workflow、README、requirements 或脚本代码。
            最后输出一行摘要：pipeline done。
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          AI_MODEL: ${{ secrets.AI_MODEL }}
          WEBHOOK_URL: ${{ secrets.WEBHOOK_URL }}
          WEBHOOK_SECRET: ${{ secrets.WEBHOOK_SECRET }}

      - name: Commit generated artifacts
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add config/sources.yaml data web
          git diff --cached --quiet || git commit -m "chore: daily ai news update"
          git push

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: web

  deploy:
    needs: collect
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
